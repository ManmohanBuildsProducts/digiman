{% extends "base.html" %}

{% block title %}Backlog - Digiman{% endblock %}

{% block content %}
<!-- Filter bar -->
{% include "partials/tag_filter_bar.html" %}

<div id="todo-container">
    <!-- Backlog Section -->
    <div id="backlog-section" class="mb-6">
        <div class="section-header flex items-center gap-3 py-3 border-b border-gray-200">
            <div class="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center">
                <i data-lucide="archive" class="w-4 h-4 text-slate-600"></i>
            </div>
            <div>
                <h2 class="text-sm font-bold text-gray-900 uppercase tracking-wide">Backlog</h2>
                <p class="text-xs text-gray-500">No deadline - do when ready</p>
            </div>
            {% if todos %}
            <span class="ml-auto px-2.5 py-0.5 bg-slate-100 text-slate-700 text-xs font-bold rounded-full">{{ todos|length }}</span>
            {% endif %}
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mt-3 overflow-hidden">
            <div class="todo-section-content divide-y divide-gray-100">
                {% if todos %}
                    {% for todo in todos %}
                        {% include "partials/todo_item.html" %}
                    {% endfor %}
                {% else %}
                    <div class="p-10 text-center">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-slate-50 to-gray-50 rounded-2xl flex items-center justify-center">
                            <i data-lucide="archive" class="w-8 h-8 text-slate-400"></i>
                        </div>
                        <p class="text-gray-900 font-medium">Backlog is empty</p>
                        <p class="text-gray-500 text-sm mt-1">Add items here that don't have a deadline</p>
                    </div>
                {% endif %}
            </div>
            <!-- Add todo to backlog -->
            <div class="p-4 border-t border-gray-100 bg-gray-50/50">
                <form class="add-todo-form" data-timeline="backlog">
                    <div class="flex gap-2">
                        <div class="input-with-hint flex-1 relative">
                            <input type="text"
                                   placeholder="Add something to the backlog..."
                                   class="todo-title-input w-full px-4 py-2.5 text-sm border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent bg-white"
                                   autocomplete="off">
                            <span class="input-hint">Press Enter</span>
                        </div>
                        <button type="submit"
                                class="submit-btn px-5 py-2.5 text-sm bg-slate-600 text-white rounded-xl font-medium hover:bg-slate-700 transition-colors flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">Add</span>
                        </button>
                    </div>
                    <div class="desc-row hidden mt-3 space-y-3">
                        <input type="text"
                               placeholder="Add more details..."
                               class="todo-desc-input w-full px-4 py-2.5 text-sm border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent bg-white">
                        <div>
                            <input type="text"
                                   placeholder="Tags (comma-separated, e.g. d2r, logistics)"
                                   class="todo-tags-input w-full px-4 py-2.5 text-sm border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent bg-white">
                            <div class="tag-preview flex flex-wrap gap-1.5 mt-2"></div>
                        </div>
                    </div>
                    <button type="button" class="toggle-desc text-xs text-gray-500 hover:text-slate-600 mt-2 flex items-center gap-1 transition-colors">
                        <i data-lucide="plus" class="w-3 h-3"></i>
                        <span>Add details</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Toggle description field
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.toggle-desc')) return;

        const btn = e.target.closest('.toggle-desc');
        const form = btn.closest('form');
        const descRow = form.querySelector('.desc-row');
        const icon = btn.querySelector('i');
        const text = btn.querySelector('span');

        if (descRow.classList.contains('hidden')) {
            descRow.classList.remove('hidden');
            text.textContent = 'Hide details';
            icon.setAttribute('data-lucide', 'minus');
            lucide.createIcons();
            descRow.querySelector('input').focus();
        } else {
            descRow.classList.add('hidden');
            text.textContent = 'Add details';
            icon.setAttribute('data-lucide', 'plus');
            lucide.createIcons();
        }
    });

    // Handle all add-todo-form submissions
    document.addEventListener('submit', async function(e) {
        const form = e.target.closest('.add-todo-form');
        if (!form) return;

        e.preventDefault();

        const titleInput = form.querySelector('.todo-title-input');
        const descInput = form.querySelector('.todo-desc-input');
        const tagsInput = form.querySelector('.todo-tags-input');
        const submitBtn = form.querySelector('.submit-btn');
        const title = titleInput.value.trim();
        const description = descInput ? descInput.value.trim() : '';
        const tags = tagsInput ? tagsInput.value.trim() : '';

        if (!title) {
            titleInput.focus();
            titleInput.classList.add('ring-2', 'ring-red-500');
            setTimeout(() => titleInput.classList.remove('ring-2', 'ring-red-500'), 1000);
            return;
        }

        const timeline = form.dataset.timeline;

        const payload = {
            title: title,
            description: description || null,
            timeline_type: timeline,
            tags: tags || null
        };

        // Show loading state
        submitBtn.classList.add('btn-loading');
        titleInput.disabled = true;

        try {
            const response = await fetch('/api/todos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'HX-Request': 'true'
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                const html = await response.text();
                const section = document.querySelector('#backlog-section .todo-section-content');

                if (section) {
                    const emptyState = section.querySelector('.text-center');
                    if (emptyState) {
                        emptyState.remove();
                    }
                    section.insertAdjacentHTML('beforeend', html);
                    lucide.createIcons();
                    initSortable();
                }

                // Clear inputs
                titleInput.value = '';
                if (descInput) descInput.value = '';
                if (tagsInput) {
                    tagsInput.value = '';
                    const tagPreview = form.querySelector('.tag-preview');
                    if (tagPreview) tagPreview.innerHTML = '';
                }
                const descRow = form.querySelector('.desc-row');
                const toggleBtn = form.querySelector('.toggle-desc');
                if (descRow && !descRow.classList.contains('hidden')) {
                    descRow.classList.add('hidden');
                    toggleBtn.querySelector('span').textContent = 'Add details';
                    toggleBtn.querySelector('i').setAttribute('data-lucide', 'plus');
                    lucide.createIcons();
                }

                showToast('Todo added!', 'success');
            } else {
                showToast('Failed to add todo', 'warning');
            }
        } catch (error) {
            console.error('Error adding todo:', error);
            showToast('Something went wrong', 'warning');
        } finally {
            submitBtn.classList.remove('btn-loading');
            titleInput.disabled = false;
            titleInput.focus();
        }
    });

    // Tag input preview
    document.addEventListener('input', function(e) {
        if (!e.target.classList.contains('todo-tags-input')) return;

        const form = e.target.closest('form');
        const preview = form.querySelector('.tag-preview');
        if (!preview) return;

        const tags = e.target.value.split(',').map(t => t.trim().toLowerCase()).filter(t => t);

        preview.innerHTML = tags.map(tag => `
            <span class="tag-chip">
                <span class="tag-dot" style="background-color: ${getTagColor(tag)};"></span>
                ${tag}
            </span>
        `).join('');
    });
</script>
{% endblock %}
