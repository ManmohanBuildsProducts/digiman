<div class="todo-item p-4 {% if todo.status == 'completed' %}completed{% endif %} {% if todo.is_overdue and todo.status != 'completed' %}overdue-item{% endif %}"
     id="todo-{{ todo.id }}"
     x-data="{ editing: false }">
    <!-- View Mode -->
    <div class="flex items-start gap-3" x-show="!editing">
        <!-- Drag Handle -->
        <div class="drag-handle flex-shrink-0 mt-1 text-gray-400 dark:text-gray-500 touch-none">
            <i data-lucide="grip-vertical" class="w-4 h-4"></i>
        </div>

        <!-- Checkbox -->
        <input type="checkbox"
               class="checkbox-custom mt-0.5"
               {% if todo.status == 'completed' %}checked{% endif %}
               hx-post="/api/todos/{{ todo.id }}/toggle"
               hx-target="#todo-{{ todo.id }}"
               hx-swap="outerHTML"
               aria-label="Mark todo as {% if todo.status == 'completed' %}incomplete{% else %}complete{% endif %}">

        <!-- Content -->
        <div class="flex-1 min-w-0">
            <div class="flex items-start justify-between gap-2">
                <div class="flex-1">
                    <p class="todo-title text-sm font-medium text-gray-900 dark:text-gray-100 leading-snug">{{ todo.title }}</p>

                    <!-- Description -->
                    {% if todo.description %}
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 leading-relaxed">{{ todo.description }}</p>
                    {% endif %}

                    <!-- Tags -->
                    {% if todo.tags %}
                    <div class="flex flex-wrap gap-1.5 mt-2">
                        {% for tag in todo.tags %}
                        <a href="?tag={{ tag }}" class="tag-chip" onclick="event.stopPropagation();">
                            <span class="tag-dot" style="background-color: {{ tag_color(tag) }};"></span>
                            {{ tag }}
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- Expand hint icon -->
                <div class="expand-hint flex-shrink-0 text-gray-400 dark:text-gray-500 transition-transform">
                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                </div>
            </div>

            <!-- Source context -->
            {% if todo.source_context %}
            <div class="flex items-center gap-1.5 mt-2">
                <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs rounded-full">
                    {% if todo.source_type == 'granola' %}
                    <span>üìù</span>
                    {% elif todo.source_type == 'slack' %}
                    <span>üí¨</span>
                    {% else %}
                    <span>üìå</span>
                    {% endif %}
                    {{ todo.source_context|truncate(30) }}
                </span>
                {% if todo.source_url %}
                <a href="{{ todo.source_url }}" target="_blank" class="text-blue-500 hover:text-blue-600 p-1 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded transition-colors">
                    <i data-lucide="external-link" class="w-3.5 h-3.5"></i>
                </a>
                {% endif %}
            </div>
            {% endif %}

            <!-- Due date display -->
            {% if todo.due_date and todo.status != 'completed' %}
            <div class="flex items-center gap-1.5 mt-2">
                <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs rounded-full">
                    <i data-lucide="calendar" class="w-3 h-3"></i>
                    {{ todo.due_date }}
                </span>
            </div>
            {% endif %}

            <!-- Overdue badge -->
            {% if todo.is_overdue and todo.status != 'completed' %}
            <div class="mt-2">
                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 text-xs font-semibold rounded-full">
                    <span class="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></span>
                    {{ todo.days_overdue }} day{% if todo.days_overdue > 1 %}s{% endif %} overdue
                </span>
            </div>
            {% endif %}

            <!-- Action buttons (shown when card is expanded) -->
            {% if todo.status != 'completed' %}
            <div class="action-buttons mt-4 pt-3 border-t border-gray-100 dark:border-gray-700">
                <div class="flex flex-wrap gap-2">
                    <!-- Edit button -->
                    <button @click.stop="editing = true; $nextTick(() => $refs.editTitle{{ todo.id }}.focus())"
                            class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium bg-amber-50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 rounded-lg hover:bg-amber-100 dark:hover:bg-amber-900/50 transition-colors">
                        <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
                        Edit
                    </button>

                    <!-- Primary actions - contextual -->
                    {% if todo.timeline_type != 'date' or todo.due_date != today %}
                    <button hx-post="/api/todos/{{ todo.id }}/reassign"
                            hx-headers='{"Content-Type": "application/json"}'
                            hx-vals='{"timeline_type": "today"}'
                            hx-target="#todo-{{ todo.id }}"
                            hx-swap="outerHTML"
                            class="reassign-btn inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i data-lucide="calendar" class="w-3.5 h-3.5"></i>
                        Do Today
                    </button>
                    {% endif %}

                    <button hx-post="/api/todos/{{ todo.id }}/reassign"
                            hx-headers='{"Content-Type": "application/json"}'
                            hx-vals='{"timeline_type": "tomorrow"}'
                            hx-target="#todo-{{ todo.id }}"
                            hx-swap="delete"
                            class="reassign-btn inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        <i data-lucide="arrow-right" class="w-3.5 h-3.5"></i>
                        Tomorrow
                    </button>

                    <button hx-post="/api/todos/{{ todo.id }}/reassign"
                            hx-headers='{"Content-Type": "application/json"}'
                            hx-vals='{"timeline_type": "this_week"}'
                            hx-target="#todo-{{ todo.id }}"
                            hx-swap="delete"
                            class="reassign-btn inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium bg-purple-50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/50 transition-colors">
                        <i data-lucide="calendar-range" class="w-3.5 h-3.5"></i>
                        This Week
                    </button>

                    <!-- Secondary actions -->
                    <div class="flex-1"></div>

                    <button hx-post="/api/todos/{{ todo.id }}/reassign"
                            hx-headers='{"Content-Type": "application/json"}'
                            hx-vals='{"timeline_type": "backlog"}'
                            hx-target="#todo-{{ todo.id }}"
                            hx-swap="delete"
                            class="reassign-btn inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
                            title="Move to backlog">
                        <i data-lucide="archive" class="w-3.5 h-3.5"></i>
                        <span class="hidden sm:inline">Backlog</span>
                    </button>

                    <button hx-delete="/api/todos/{{ todo.id }}"
                            hx-target="#todo-{{ todo.id }}"
                            hx-swap="delete"
                            hx-confirm="Delete this todo?"
                            class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors"
                            title="Delete">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                        <span class="hidden sm:inline">Delete</span>
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Edit Mode -->
    <div class="edit-mode p-1" x-show="editing" x-cloak @click.stop>
        <div class="space-y-3">
            <div>
                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Title</label>
                <input type="text"
                       x-ref="editTitle{{ todo.id }}"
                       id="edit-title-{{ todo.id }}"
                       value="{{ todo.title }}"
                       class="edit-title w-full px-3 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800 dark:text-gray-100"
                       @keydown.enter="saveTodoEdit({{ todo.id }}); editing = false"
                       @keydown.escape="editing = false">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Description</label>
                <textarea id="edit-desc-{{ todo.id }}"
                          rows="2"
                          class="edit-desc w-full px-3 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800 dark:text-gray-100 resize-none"
                          @keydown.escape="editing = false">{{ todo.description or '' }}</textarea>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Tags (comma-separated)</label>
                <input type="text"
                       id="edit-tags-{{ todo.id }}"
                       value="{{ todo.tags|join(', ') }}"
                       class="edit-tags w-full px-3 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800 dark:text-gray-100"
                       @keydown.escape="editing = false">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Due Date</label>
                <input type="date"
                       id="edit-date-{{ todo.id }}"
                       value="{{ todo.due_date or '' }}"
                       class="edit-date w-full px-3 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800 dark:text-gray-100"
                       @keydown.escape="editing = false">
            </div>
            <div class="flex gap-2 pt-2">
                <button @click="saveTodoEdit({{ todo.id }}); editing = false"
                        class="flex-1 px-4 py-2 text-sm font-medium bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Save
                </button>
                <button @click="cancelTodoEdit({{ todo.id }}); editing = false"
                        class="px-4 py-2 text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
