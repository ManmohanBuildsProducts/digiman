<div class="todo-item p-4 {% if todo.status == 'completed' %}completed{% endif %} {% if todo.is_overdue and todo.status != 'completed' %}overdue-item{% endif %}"
     id="todo-{{ todo.id }}">
    <div class="flex items-start gap-3">
        <!-- Drag Handle -->
        <div class="drag-handle flex-shrink-0 mt-1 text-gray-400 touch-none">
            <i data-lucide="grip-vertical" class="w-4 h-4"></i>
        </div>

        <!-- Checkbox -->
        <input type="checkbox"
               class="checkbox-custom mt-0.5"
               {% if todo.status == 'completed' %}checked{% endif %}
               hx-post="/api/todos/{{ todo.id }}/toggle"
               hx-target="#todo-{{ todo.id }}"
               hx-swap="outerHTML">

        <!-- Content -->
        <div class="flex-1 min-w-0">
            <div class="flex items-start justify-between gap-2">
                <div class="flex-1">
                    <p class="todo-title text-sm font-medium text-gray-900 leading-snug">{{ todo.title }}</p>

                    <!-- Description -->
                    {% if todo.description %}
                    <p class="text-xs text-gray-500 mt-1 leading-relaxed">{{ todo.description }}</p>
                    {% endif %}

                    <!-- Tags -->
                    {% if todo.tags %}
                    <div class="flex flex-wrap gap-1.5 mt-2">
                        {% for tag in todo.tags %}
                        <a href="?tag={{ tag }}" class="tag-chip" onclick="event.stopPropagation();">
                            <span class="tag-dot" style="background-color: {{ tag_color(tag) }};"></span>
                            {{ tag }}
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- Expand hint icon -->
                <div class="expand-hint flex-shrink-0 text-gray-400 transition-transform">
                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                </div>
            </div>

            <!-- Source context -->
            {% if todo.source_context %}
            <div class="flex items-center gap-1.5 mt-2">
                <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded-full">
                    {% if todo.source_type == 'granola' %}
                    <span>üìù</span>
                    {% elif todo.source_type == 'slack' %}
                    <span>üí¨</span>
                    {% else %}
                    <span>üìå</span>
                    {% endif %}
                    {{ todo.source_context|truncate(30) }}
                </span>
                {% if todo.source_url %}
                <a href="{{ todo.source_url }}" target="_blank" class="text-blue-500 hover:text-blue-600 p-1 hover:bg-blue-50 rounded transition-colors">
                    <i data-lucide="external-link" class="w-3.5 h-3.5"></i>
                </a>
                {% endif %}
            </div>
            {% endif %}

            <!-- Overdue badge -->
            {% if todo.is_overdue and todo.status != 'completed' %}
            <div class="mt-2">
                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-red-100 text-red-700 text-xs font-semibold rounded-full">
                    <span class="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></span>
                    {{ todo.days_overdue }} day{% if todo.days_overdue > 1 %}s{% endif %} overdue
                </span>
            </div>
            {% endif %}

            <!-- Action buttons (shown when card is expanded) -->
            {% if todo.status != 'completed' %}
            <div class="action-buttons mt-4 pt-3 border-t border-gray-100">
                <div class="flex flex-wrap gap-2">
                    <!-- Primary actions - contextual -->
                    {% if todo.timeline_type != 'date' or todo.due_date != today %}
                    <button hx-post="/api/todos/{{ todo.id }}/reassign"
                            hx-headers='{"Content-Type": "application/json"}'
                            hx-vals='{"timeline_type": "today"}'
                            hx-target="#todo-{{ todo.id }}"
                            hx-swap="outerHTML"
                            class="reassign-btn inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i data-lucide="calendar" class="w-3.5 h-3.5"></i>
                        Do Today
                    </button>
                    {% endif %}

                    <button hx-post="/api/todos/{{ todo.id }}/reassign"
                            hx-headers='{"Content-Type": "application/json"}'
                            hx-vals='{"timeline_type": "tomorrow"}'
                            hx-target="#todo-{{ todo.id }}"
                            hx-swap="delete"
                            class="reassign-btn inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <i data-lucide="arrow-right" class="w-3.5 h-3.5"></i>
                        Tomorrow
                    </button>

                    <button hx-post="/api/todos/{{ todo.id }}/reassign"
                            hx-headers='{"Content-Type": "application/json"}'
                            hx-vals='{"timeline_type": "this_week"}'
                            hx-target="#todo-{{ todo.id }}"
                            hx-swap="delete"
                            class="reassign-btn inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 transition-colors">
                        <i data-lucide="calendar-range" class="w-3.5 h-3.5"></i>
                        This Week
                    </button>

                    <!-- Secondary actions -->
                    <div class="flex-1"></div>

                    <button hx-post="/api/todos/{{ todo.id }}/reassign"
                            hx-headers='{"Content-Type": "application/json"}'
                            hx-vals='{"timeline_type": "backlog"}'
                            hx-target="#todo-{{ todo.id }}"
                            hx-swap="delete"
                            class="reassign-btn inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-gray-500 hover:bg-gray-100 rounded-lg transition-colors"
                            title="Move to backlog">
                        <i data-lucide="archive" class="w-3.5 h-3.5"></i>
                        <span class="hidden sm:inline">Backlog</span>
                    </button>

                    <button hx-delete="/api/todos/{{ todo.id }}"
                            hx-target="#todo-{{ todo.id }}"
                            hx-swap="delete"
                            hx-confirm="Delete this todo?"
                            class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                            title="Delete">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                        <span class="hidden sm:inline">Delete</span>
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
