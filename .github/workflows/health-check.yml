name: Health Check

on:
  schedule:
    # Every 15 minutes (GitHub Actions minimum for free)
    - cron: '*/15 * * * *'
  workflow_dispatch:  # Manual trigger

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
      - name: Check site health
        id: health
        run: |
          SITE_URL="https://manmohanbuildsproducts.pythonanywhere.com"

          echo "Checking $SITE_URL..."

          # Get response with timing
          START=$(date +%s%N)
          HTTP_CODE=$(curl -s -o /tmp/response.txt -w "%{http_code}" --max-time 30 "$SITE_URL" || echo "000")
          END=$(date +%s%N)

          # Calculate response time in ms
          RESPONSE_TIME=$(( (END - START) / 1000000 ))

          echo "status=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Site is UP (${RESPONSE_TIME}ms)"
          else
            echo "ðŸš¨ Site is DOWN! Status: $HTTP_CODE"
            echo "Response body:"
            cat /tmp/response.txt || true
            exit 1
          fi

      - name: Send Slack alert on failure
        if: failure()
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "ðŸš¨ *Digiman is DOWN!*\nStatus: ${{ steps.health.outputs.status }}\nCheck: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }' \
              "${{ secrets.SLACK_WEBHOOK_URL }}"
          fi
